<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="da" style="font-size: 100%" class="lang-da">
<head>
	<title>fcoo.dk - fcoo-application - Demo</title>
	<meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta http-equiv='x-dns-prefetch-control' content='on'>

	<meta name='copyright' content='FCOO'>
	<meta name='owner' content='FCOO'>

  <link  href="bower_components.css" rel="stylesheet">	
  <link  href="../src/fcoo-application.css" rel="stylesheet">	
  <style>
    p,img {
        margin:20px;
    }
  </style>
</head>

<body>
    <div class="loading"></div>
    <p id="status"></p>
    <button onclick="demoReloadImg()">Reload image</button><br>
    <button onclick="checkAllImages()">Get status</button><br>
    <img id="img1" src="sea.jpg">
    <img id="img2" src="sea2.jpg">
    <script src="bower_components.js"></script>
	<script src="../src/fcoo-application.js"></script>
	<script>
        function demoReloadImg(){
            var random = new Date().getTime();
            $('#img1').prop('src', 'sea.jpg?param1=value1&param2=value2&_='+random);
            $('#img2').prop('src', 'sea2.jpg?_='+random);
        }

        function load(e){ 
console.log('load', e);
            $(e.target)
                .removeAttr('originalSrc')
                .off('error', error )
                .off('load', load );
        }

        function error(e){ 
console.log('error', e);
            var img = e.target;
            var src = $(img).attr('originalSrc');
            load(e);
            img.src = src;
        }

        function reloadImg( img, index ){
            var $img = $(img); console.log(index,' before',img);

$img.attr('originalSrc', img.src);
            $img
                .on('load', load )
                .on('error', error );
            //img.onerror = error;
            if (index)
                img.src = 'findesikke.jpg';
            else {
            //$img.off('error', error);
//            img.src = 'findeshellerikke.jpg';            
//            console.log(index,' after',img);
//            var tempImg = new Image();
//            tempImg.src = img.src;

            var src = img.src;
                param = {};
                if (src.indexOf('?') > -1){
                    var srcSplit = src.split('?');
                    src = srcSplit[0];
                    param = Url.parseQuery( srcSplit[1] );
                }
                param['niels'] = new Date().getTime();
                img.src = src + '?' + Url.stringify( param );
            }
        }

        checkAllImages = function(){
//            var str = '';
            var imgLoad = imagesLoaded('body',/*);
            imgLoad.on( 'always', */function() {
                // detect which image is broken
                $.each( imgLoad.images, function( index, image ){
//                    if (!image.isLoaded)
                        reloadImg( image.img, index );                
                });
//                for (var i=0; i<imgLoad.images.length; i++ ){
//                    var image = imgLoad.images[i];
//                    var result = image.isLoaded ? 'loaded' : 'broken';
//                    str = str + '<br>image is ' + result + ' for ' + image.img.src ;
//                    console.log( 'image is ' + result + ' for ' + image.img.src );
//                    if (!image.isLoaded)
//                        reloadImg( image.img );
//                }
//                $('#status').html( str );
           });
        };

        Offline.on('up', checkAllImages);
        
        
        
        
        
        
        
        
        

    </script>
</body>
</html>
